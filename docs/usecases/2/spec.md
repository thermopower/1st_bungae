# UC-002: 로그인

## 1. 유스케이스 정보

| 항목 | 내용 |
|------|------|
| **유스케이스 ID** | UC-002 |
| **유스케이스 이름** | 로그인 |
| **액터** | 비로그인 사용자 (계정 보유) |
| **우선순위** | 높음 |
| **관련 기능** | 인증 |

## 2. 사전조건 (Preconditions)

- 사용자가 이미 회원가입을 완료함
- 로그인 페이지에 접근 가능

## 3. 사후조건 (Postconditions)

### 성공 시
- 세션 생성 (액세스 토큰, 리프레시 토큰)
- 사용자 역할에 따라 적절한 페이지로 리다이렉트
  - 역할 미등록: 역할 선택 페이지(`/role-selection`)
  - 광고주: 광고주 대시보드(`/advertiser/dashboard`)
  - 인플루언서: 홈(체험단 탐색)(`/`)

### 실패 시
- 에러 메시지 표시
- 로그인 페이지 유지

## 4. 주요 플로우 (Main Flow)

1. 사용자가 로그인 페이지(`/auth/login`)에 접속
2. 이메일 주소 입력
3. 비밀번호 입력
4. "로그인" 버튼 클릭
5. **시스템**: 입력 검증
   - 이메일 형식 검증
   - 비밀번호 입력 여부 확인
6. **시스템**: Supabase Auth API 호출 (로그인 요청)
7. **시스템**: Supabase 응답 처리
   - 성공 (200 OK):
     - 세션 생성 (액세스 토큰, 리프레시 토큰 저장)
8. **시스템**: DB에서 사용자 정보 조회 (User 테이블)
9. **시스템**: 사용자 역할 확인
   - Advertiser 테이블 조회
   - Influencer 테이블 조회
10. **시스템**: 역할에 따라 리다이렉트
    - 역할 미등록: `/role-selection`
    - 광고주: `/advertiser/dashboard`
    - 인플루언서: `/`

## 5. 대체 플로우 (Alternative Flows)

### 5.1 이메일 형식 오류
- **시점**: 5단계 (입력 검증)
- **조건**: 이메일 형식이 올바르지 않음
- **처리**:
  - "올바른 이메일 형식을 입력해주세요" 메시지 표시
  - 플로우 중단

### 5.2 이메일 또는 비밀번호 불일치
- **시점**: 7단계 (Supabase 응답 처리)
- **조건**: 인증 실패 (401 Unauthorized)
- **처리**:
  - "이메일 또는 비밀번호가 일치하지 않습니다" 메시지 표시
  - 플로우 중단

## 6. 예외 플로우 (Exception Flows)

### 6.1 이메일 미인증 (Phase 2)
- **조건**: Supabase에서 이메일 미인증 상태 반환
- **처리**:
  - "이메일 인증을 완료해주세요" 메시지 표시
  - 인증 메일 재발송 버튼 제공
  - 플로우 중단

### 6.2 계정 정지 (Phase 2)
- **조건**: 관리자가 계정을 정지한 경우
- **처리**:
  - "계정이 정지되었습니다. 관리자에게 문의하세요" 메시지 표시
  - 플로우 중단

### 6.3 네트워크 오류
- **조건**: Supabase Auth API 호출 실패
- **처리**:
  - "네트워크 연결을 확인해주세요" 메시지 표시
  - 플로우 중단

### 6.4 세션 생성 실패
- **조건**: 서버에서 세션 생성 실패
- **처리**:
  - "일시적인 오류가 발생했습니다. 다시 시도해주세요" 메시지 표시
  - 플로우 중단

## 7. 비즈니스 규칙 (Business Rules)

### BR-001: 로그인 실패 제한 (Phase 2)
- 5회 연속 로그인 실패 시 계정 잠금
- 15분 후 자동 잠금 해제

### BR-002: 세션 유효 기간
- 액세스 토큰 유효 기간: 1시간
- 리프레시 토큰 유효 기간: 7일
- 토큰 만료 시 자동 갱신 또는 재로그인 요구

### BR-003: 역할별 리다이렉트
- 광고주: 광고주 대시보드로 이동
- 인플루언서: 홈(체험단 탐색)으로 이동
- 역할 미등록: 역할 선택 페이지로 이동

### BR-004: 중복 로그인 허용
- 동일 계정으로 여러 기기에서 동시 로그인 가능
- 각 세션은 독립적으로 관리

## 8. UI/UX 요구사항

### 입력 필드
- 이메일: 텍스트 입력 (type="email")
- 비밀번호: 비밀번호 입력 (type="password")

### 버튼
- "로그인" 버튼 (Primary)
- "회원가입 페이지로 이동" 링크

### 메시지
- 성공: "로그인되었습니다"
- 에러: "이메일 또는 비밀번호가 일치하지 않습니다"

## 9. 데이터 모델

### 입력 데이터
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

### 출력 데이터 (성공 시)
```json
{
  "user_id": "uuid-v4",
  "email": "user@example.com",
  "role": "advertiser" | "influencer" | null,
  "access_token": "eyJhbGc...",
  "refresh_token": "v1.MR5S..."
}
```

## 10. 시퀀스 다이어그램

```
사용자 -> 로그인 페이지: 접속
로그인 페이지 -> 사용자: 입력 폼 표시
사용자 -> 로그인 페이지: 정보 입력 및 제출
로그인 페이지 -> WTForms: 입력 검증
WTForms --> 로그인 페이지: 검증 성공
로그인 페이지 -> Supabase Auth: 로그인 요청
Supabase Auth --> 로그인 페이지: 200 OK + 세션 토큰
로그인 페이지 -> DB (User): User 정보 조회
DB (User) --> 로그인 페이지: User 정보 반환
로그인 페이지 -> DB (Advertiser/Influencer): 역할 정보 조회
DB (Advertiser/Influencer) --> 로그인 페이지: 역할 정보 반환
로그인 페이지 -> Flask Session: 세션 저장
Flask Session --> 로그인 페이지: 세션 생성 완료
로그인 페이지 -> 사용자: 역할별 페이지로 리다이렉트
```

## 11. 테스트 시나리오

### 11.1 정상 로그인 (광고주)
- **Given**: 광고주 정보가 등록된 사용자
- **When**: 올바른 이메일과 비밀번호로 로그인
- **Then**: 세션 생성, 광고주 대시보드로 이동

### 11.2 정상 로그인 (인플루언서)
- **Given**: 인플루언서 정보가 등록된 사용자
- **When**: 올바른 이메일과 비밀번호로 로그인
- **Then**: 세션 생성, 홈(체험단 탐색)으로 이동

### 11.3 정상 로그인 (역할 미등록)
- **Given**: 회원가입만 완료한 사용자
- **When**: 올바른 이메일과 비밀번호로 로그인
- **Then**: 세션 생성, 역할 선택 페이지로 이동

### 11.4 로그인 실패 (잘못된 비밀번호)
- **Given**: 등록된 이메일 존재
- **When**: 잘못된 비밀번호 입력
- **Then**: "이메일 또는 비밀번호가 일치하지 않습니다" 에러 메시지 표시

### 11.5 로그인 실패 (존재하지 않는 이메일)
- **Given**: 등록되지 않은 이메일
- **When**: 로그인 시도
- **Then**: "이메일 또는 비밀번호가 일치하지 않습니다" 에러 메시지 표시

## 12. 참고 문서

- `docs/userflow.md`: 로그인 플로우 (1.3)
- `docs/prd.md`: 로그인 기능 요구사항 (6.1.2)
- `docs/database.md`: User 테이블 스키마 (3.1)
