# UC-010: 체험단 지원

## 1. 유스케이스 정보

| 항목 | 내용 |
|------|------|
| **유스케이스 ID** | UC-010 |
| **유스케이스 이름** | 체험단 지원 |
| **액터** | 인플루언서 (정보 등록 완료) |
| **우선순위** | 높음 |
| **관련 기능** | 체험단 지원 |

## 2. 사전조건 (Preconditions)

- 사용자가 로그인 상태
- User.role이 'influencer'
- Influencer 정보가 등록되어 있음
- Campaign.status가 'RECRUITING'
- 현재 날짜가 모집 기간 내 (start_date ≤ 현재 ≤ end_date)

## 3. 사후조건 (Postconditions)

### 성공 시
- Application 테이블에 새 레코드 생성
- Application.status가 'APPLIED'로 설정
- 체험단 상세 페이지로 리다이렉트
- "지원이 완료되었습니다" 메시지 표시

### 실패 시
- 에러 메시지 표시
- 지원 페이지 또는 체험단 상세 페이지 유지

## 4. 주요 플로우 (Main Flow)

1. 인플루언서가 체험단 상세 페이지에서 "지원하기" 버튼 클릭
2. 체험단 지원 페이지(`/campaign/<campaign_id>/apply`)로 이동
3. 지원 사유 입력 (텍스트 영역, 선택사항, 최대 1000자)
4. "지원하기" 버튼 클릭
5. **시스템**: 로그인 여부 검증
6. **시스템**: 인플루언서 정보 등록 여부 검증
   - Influencer 테이블에서 user_id로 레코드 조회
   - 인플루언서 정보 미등록 시: "인플루언서 정보를 먼저 등록해주세요" + 정보 등록 페이지로 리다이렉트
7. **시스템**: 체험단 존재 여부 검증
   - campaign_id로 Campaign 조회
   - 체험단 없음: 404 페이지 표시
8. **시스템**: 모집 상태 검증
   - Campaign.status 확인
   - 모집 종료 (CLOSED): "모집이 종료된 체험단입니다" + 체험단 상세 페이지로 리다이렉트
9. **시스템**: 모집 기간 검증
   - 현재 날짜가 start_date ≤ 현재 ≤ end_date 확인
   - 모집 기간 외: "모집 기간이 아닙니다" + 체험단 상세 페이지로 리다이렉트
10. **시스템**: 중복 지원 검증
    - Application 테이블에서 (campaign_id, influencer_id) 조회
    - 이미 지원한 경우: "이미 지원한 체험단입니다" + 체험단 상세 페이지로 리다이렉트
11. **시스템**: 모집 인원 초과 검증 (선택적)
    - Campaign.quota와 현재 지원자 수 (Application COUNT) 비교
    - 정원 초과: "모집 인원이 마감되었습니다" + 체험단 상세 페이지로 리다이렉트
12. **시스템**: 지원 사유 검증 (선택사항)
    - 입력된 경우: 1000자 이하 검증
13. **시스템**: Application 테이블에 레코드 생성
    - campaign_id, influencer_id, application_reason, status='APPLIED', applied_at=NOW()
14. **시스템**: 체험단 상세 페이지(`/campaign/<campaign_id>`)로 리다이렉트
15. **시스템**: "지원이 완료되었습니다" 메시지 표시

## 5. 대체 플로우 (Alternative Flows)

### 5.1 미로그인 상태
- **시점**: 5단계 (로그인 검증)
- **조건**: 세션에 user_id 없음
- **처리**:
  - 로그인 페이지로 리다이렉트

### 5.2 인플루언서 정보 미등록
- **시점**: 6단계 (인플루언서 정보 등록 검증)
- **조건**: Influencer 테이블에 user_id로 레코드 없음
- **처리**:
  - "인플루언서 정보를 먼저 등록해주세요" 메시지 표시
  - 인플루언서 정보 등록 페이지로 리다이렉트

### 5.3 체험단 없음
- **시점**: 7단계 (체험단 존재 검증)
- **조건**: Campaign 없음
- **처리**:
  - 404 페이지 표시

### 5.4 모집 종료된 체험단
- **시점**: 8단계 (모집 상태 검증)
- **조건**: Campaign.status = 'CLOSED' 또는 'SELECTED'
- **처리**:
  - "모집이 종료된 체험단입니다" 메시지 표시
  - 체험단 상세 페이지로 리다이렉트

### 5.5 모집 기간 외
- **시점**: 9단계 (모집 기간 검증)
- **조건**: 현재 날짜 < start_date 또는 현재 날짜 > end_date
- **처리**:
  - "모집 기간이 아닙니다" 메시지 표시
  - 체험단 상세 페이지로 리다이렉트

### 5.6 중복 지원
- **시점**: 10단계 (중복 지원 검증)
- **조건**: Application 테이블에 (campaign_id, influencer_id) 존재
- **처리**:
  - "이미 지원한 체험단입니다" 메시지 표시
  - 체험단 상세 페이지로 리다이렉트

### 5.7 모집 인원 초과
- **시점**: 11단계 (모집 인원 초과 검증)
- **조건**: Application COUNT >= Campaign.quota
- **처리**:
  - "모집 인원이 마감되었습니다" 메시지 표시
  - 체험단 상세 페이지로 리다이렉트

### 5.8 지원 사유 너무 긴 경우
- **시점**: 12단계 (지원 사유 검증)
- **조건**: application_reason 길이 > 1000자
- **처리**:
  - "지원 사유는 최대 1000자입니다" 에러 메시지 표시
  - 플로우 중단

## 6. 예외 플로우 (Exception Flows)

### 6.1 DB 저장 실패
- **조건**: Application 레코드 생성 실패
- **처리**:
  - "일시적인 오류가 발생했습니다. 다시 시도해주세요" 메시지 표시
  - 플로우 중단

### 6.2 동시성 문제 (Race Condition)
- **조건**: 여러 사용자가 동시에 마지막 자리에 지원
- **처리**:
  - 트랜잭션 격리 수준 설정 (SERIALIZABLE 또는 SELECT FOR UPDATE)
  - 재시도 로직
  - "모집 인원이 마감되었습니다" 메시지 표시

## 7. 비즈니스 규칙 (Business Rules)

### BR-001: 인플루언서만 지원 가능
- Influencer 테이블에 레코드가 있어야 지원 가능
- 광고주는 지원 불가

### BR-002: 중복 지원 방지
- Application 테이블의 (campaign_id, influencer_id) UNIQUE 제약조건
- 한 인플루언서는 한 체험단에 한 번만 지원 가능

### BR-003: 모집 중 상태만 지원 가능
- Campaign.status = 'RECRUITING'일 때만 지원 가능
- 'CLOSED' 또는 'SELECTED' 상태는 지원 불가

### BR-004: 모집 기간 내 지원 가능
- start_date ≤ 현재 날짜 ≤ end_date
- 모집 기간 외에는 지원 불가

### BR-005: 지원 사유 선택사항
- application_reason은 NULL 허용
- 입력 시 최대 1000자

### BR-006: 모집 인원 초과 시 지원 불가 (선택적)
- Phase 1에서는 선착순이 아닌 광고주 선정 방식
- 정원 초과 지원 허용 가능 (광고주가 선정)

## 8. UI/UX 요구사항

### 입력 필드
- 지원 사유: 텍스트 영역 (선택, 최대 1000자)

### 버튼
- "지원하기" 버튼 (Primary)
- "취소" 버튼 (Secondary) → 체험단 상세 페이지로 이동

### 메시지
- 성공: "지원이 완료되었습니다"
- 에러:
  - "인플루언서 정보를 먼저 등록해주세요"
  - "모집이 종료된 체험단입니다"
  - "모집 기간이 아닙니다"
  - "이미 지원한 체험단입니다"
  - "모집 인원이 마감되었습니다"
  - "지원 사유는 최대 1000자입니다"

## 9. 데이터 모델

### 입력 데이터
```json
{
  "campaign_id": 1,
  "application_reason": "저는 뷰티 인플루언서로 활동하고 있으며, 파스타 리뷰 경험이 풍부합니다."
}
```

### 출력 데이터 (성공 시)
```json
{
  "application_id": 1,
  "campaign_id": 1,
  "influencer_id": 1,
  "status": "APPLIED",
  "applied_at": "2025-11-14T12:00:00Z"
}
```

## 10. 시퀀스 다이어그램

```
인플루언서 -> 체험단 상세 페이지: "지원하기" 클릭
체험단 상세 페이지 -> 지원 페이지: 이동
지원 페이지 -> 인플루언서: 지원 사유 입력 폼 표시
인플루언서 -> 지원 페이지: 지원 사유 입력 및 제출
지원 페이지 -> AuthService: 로그인 검증
AuthService --> 지원 페이지: 검증 성공
지원 페이지 -> DB (Influencer): 인플루언서 정보 등록 검증
DB (Influencer) --> 지원 페이지: 검증 성공
지원 페이지 -> DB (Campaign): 체험단 존재, 상태, 기간 검증
DB (Campaign) --> 지원 페이지: 검증 성공
지원 페이지 -> DB (Application): 중복 지원 검증
DB (Application) --> 지원 페이지: 중복 없음
지원 페이지 -> DB (Application): Application 생성 (status=APPLIED)
DB (Application) --> 지원 페이지: 생성 완료
지원 페이지 -> 인플루언서: 체험단 상세 페이지로 리다이렉트
```

## 11. 테스트 시나리오

### 11.1 정상 지원 (지원 사유 있음)
- **Given**: 로그인된 인플루언서, 모집 중인 체험단
- **When**: 지원 사유 입력 후 "지원하기" 클릭
- **Then**: Application 생성, "지원이 완료되었습니다" 메시지

### 11.2 정상 지원 (지원 사유 없음)
- **Given**: 로그인된 인플루언서, 모집 중인 체험단
- **When**: 지원 사유 입력 없이 "지원하기" 클릭
- **Then**: Application 생성 (application_reason = NULL), "지원이 완료되었습니다" 메시지

### 11.3 중복 지원
- **Given**: 이미 지원한 체험단
- **When**: 다시 지원 시도
- **Then**: "이미 지원한 체험단입니다" 에러 메시지

### 11.4 모집 종료된 체험단
- **Given**: 모집 종료된 체험단 (status = 'CLOSED')
- **When**: 지원 시도
- **Then**: "모집이 종료된 체험단입니다" 에러 메시지

### 11.5 모집 기간 외
- **Given**: 모집 기간이 아닌 체험단
- **When**: 지원 시도
- **Then**: "모집 기간이 아닙니다" 에러 메시지

### 11.6 인플루언서 정보 미등록
- **Given**: 인플루언서 정보가 등록되지 않은 사용자
- **When**: 지원 시도
- **Then**: "인플루언서 정보를 먼저 등록해주세요" 메시지, 정보 등록 페이지로 리다이렉트

## 12. 참고 문서

- `docs/userflow.md`: 체험단 지원 플로우 (5.3)
- `docs/prd.md`: 체험단 지원 기능 요구사항 (6.3.4)
- `docs/database.md`: Application 테이블 스키마 (3.5)
