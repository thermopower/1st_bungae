# UC-005: 체험단 생성

## 1. 유스케이스 정보

| 항목 | 내용 |
|------|------|
| **유스케이스 ID** | UC-005 |
| **유스케이스 이름** | 체험단 생성 |
| **액터** | 광고주 |
| **우선순위** | 높음 |
| **관련 기능** | 체험단 관리 |

## 2. 사전조건 (Preconditions)

- 사용자가 로그인 상태
- User.role이 'advertiser'
- Advertiser 정보가 등록되어 있음

## 3. 사후조건 (Postconditions)

### 성공 시
- Campaign 테이블에 새 레코드 생성
- Campaign.status가 'RECRUITING'으로 설정
- 이미지가 있는 경우 Supabase Storage에 업로드
- 광고주 대시보드로 리다이렉트

### 실패 시
- 에러 메시지 표시
- 체험단 생성 페이지 유지

## 4. 주요 플로우 (Main Flow)

1. 광고주가 광고주 대시보드에서 "체험단 생성" 버튼 클릭
2. 체험단 생성 페이지(`/advertiser/campaign/create`)로 이동
3. 다음 정보 입력:
   - 체험단 제목 (5자 이상 100자 이하)
   - 체험단 설명 (20자 이상 2000자 이하)
   - 모집 인원 (1명 이상 100명 이하)
   - 모집 시작일 (YYYY-MM-DD, 오늘 이후)
   - 모집 종료일 (YYYY-MM-DD, 시작일 이후)
   - 제공 혜택 (10자 이상 500자 이하)
   - 체험 조건 (10자 이상 500자 이하)
   - 대표 이미지 업로드 (선택, 최대 5MB, jpg/png/gif)
4. "등록" 버튼 클릭
5. **시스템**: 로그인 여부 검증
6. **시스템**: 광고주 권한 검증
   - Advertiser 테이블에서 user_id로 레코드 조회
   - 광고주 정보 미등록 시: "광고주 정보를 먼저 등록해주세요" + 광고주 정보 등록 페이지로 리다이렉트
7. **시스템**: 입력 검증
   - 체험단 제목: 5자 이상 100자 이하
   - 체험단 설명: 20자 이상 2000자 이하
   - 모집 인원: 1명 이상 100명 이하
   - 모집 시작일: 오늘 이후 날짜
   - 모집 종료일: 시작일 이후 날짜
   - 제공 혜택: 10자 이상 500자 이하
   - 체험 조건: 10자 이상 500자 이하
   - 대표 이미지: jpg/png/gif, 최대 5MB
8. **시스템**: 이미지 업로드 처리 (선택사항)
   - 이미지가 있는 경우: Supabase Storage에 업로드
   - 업로드 성공 시 이미지 URL 반환
   - 이미지가 없는 경우: 기본 이미지 URL 사용
9. **시스템**: Campaign 테이블에 레코드 생성
   - advertiser_id: 현재 사용자의 Advertiser ID
   - title, description, quota, start_date, end_date, benefits, conditions
   - image_url: 업로드된 이미지 URL 또는 기본 이미지
   - status: 'RECRUITING'
   - created_at: 현재 시각
10. **시스템**: 광고주 대시보드(`/advertiser/dashboard`)로 리다이렉트
11. **시스템**: "체험단이 등록되었습니다" 메시지 표시

## 5. 대체 플로우 (Alternative Flows)

### 5.1 미로그인 상태
- **시점**: 5단계 (로그인 검증)
- **조건**: 세션에 user_id 없음
- **처리**:
  - 로그인 페이지로 리다이렉트

### 5.2 광고주 권한 없음
- **시점**: 6단계 (광고주 권한 검증)
- **조건**: Advertiser 테이블에 user_id로 레코드 없음
- **처리**:
  - "광고주 정보를 먼저 등록해주세요" 메시지 표시
  - 광고주 정보 등록 페이지로 리다이렉트

### 5.3 입력 검증 실패
- **시점**: 7단계 (입력 검증)
- **조건**: 각 필드별 검증 실패
- **처리**:
  - 구체적인 에러 메시지 표시
  - 해당 입력 필드 하이라이트
  - 플로우 중단

### 5.4 모집 종료일이 시작일보다 이른 경우
- **시점**: 7단계 (입력 검증)
- **조건**: end_date < start_date
- **처리**:
  - "모집 종료일은 시작일 이후여야 합니다" 메시지 표시
  - 플로우 중단

## 6. 예외 플로우 (Exception Flows)

### 6.1 이미지 업로드 실패
- **조건**: Supabase Storage 업로드 실패
- **처리**:
  - "이미지 업로드에 실패했습니다. 다시 시도해주세요" 메시지 표시
  - 플로우 중단

### 6.2 Storage 용량 초과
- **조건**: Supabase Storage 용량 한계 도달
- **처리**:
  - "스토리지 용량이 부족합니다. 관리자에게 문의하세요" 메시지 표시
  - 플로우 중단

### 6.3 DB 저장 실패
- **조건**: Campaign 레코드 생성 실패
- **처리**:
  - "일시적인 오류가 발생했습니다. 다시 시도해주세요" 메시지 표시
  - 이미 업로드된 이미지 삭제 (정리)
  - 플로우 중단

## 7. 비즈니스 규칙 (Business Rules)

### BR-001: 모집 기간 검증
- 모집 시작일은 오늘 이후
- 모집 종료일은 시작일 이후
- 애플리케이션 레벨에서 검증

### BR-002: 체험단 생성 시 자동 모집 중 상태
- Campaign 생성 시 status는 항상 'RECRUITING'
- 광고주가 직접 상태를 지정할 수 없음

### BR-003: 이미지 파일 제한
- 파일 형식: jpg, png, gif만 허용
- 최대 크기: 5MB
- 애플리케이션 레벨에서 검증

### BR-004: 모집 인원 제한
- 최소 1명, 최대 100명
- Campaign.quota CHECK 제약조건

## 8. UI/UX 요구사항

### 입력 필드
- 체험단 제목: 텍스트 입력
- 체험단 설명: 텍스트 영역 (에디터)
- 모집 인원: 숫자 입력
- 모집 시작일: 날짜 선택기
- 모집 종료일: 날짜 선택기
- 제공 혜택: 텍스트 영역
- 체험 조건: 텍스트 영역
- 대표 이미지: 파일 업로드 (선택)

### 버튼
- "등록" 버튼 (Primary)
- "취소" 버튼 (Secondary) → 광고주 대시보드로 이동

### 메시지
- 성공: "체험단이 등록되었습니다"
- 에러: 각 검증 실패 시 구체적인 메시지 표시

## 9. 데이터 모델

### 입력 데이터
```json
{
  "title": "신메뉴 파스타 체험단 모집",
  "description": "새로 출시한 파스타 메뉴를 체험하고 리뷰해주실 인플루언서를 모집합니다.",
  "quota": 5,
  "start_date": "2025-11-15",
  "end_date": "2025-11-30",
  "benefits": "무료 식사 제공",
  "conditions": "인스타그램 피드 1개 + 스토리 2개 업로드",
  "image": "<파일 객체>"
}
```

### 출력 데이터 (성공 시)
```json
{
  "campaign_id": 1,
  "advertiser_id": 1,
  "status": "RECRUITING",
  "image_url": "https://supabase.co/storage/v1/object/public/..."
}
```

## 10. 시퀀스 다이어그램

```
광고주 -> 광고주 대시보드: "체험단 생성" 클릭
광고주 대시보드 -> 체험단 생성 페이지: 이동
체험단 생성 페이지 -> 광고주: 입력 폼 표시
광고주 -> 체험단 생성 페이지: 정보 입력 및 제출
체험단 생성 페이지 -> AuthService: 로그인 검증
AuthService --> 체험단 생성 페이지: 검증 성공
체험단 생성 페이지 -> DB (Advertiser): 광고주 권한 검증
DB (Advertiser) --> 체험단 생성 페이지: 검증 성공
체험단 생성 페이지 -> WTForms: 입력 검증
WTForms --> 체험단 생성 페이지: 검증 성공
체험단 생성 페이지 -> Supabase Storage: 이미지 업로드 (선택)
Supabase Storage --> 체험단 생성 페이지: 이미지 URL 반환
체험단 생성 페이지 -> DB (Campaign): Campaign 생성
DB (Campaign) --> 체험단 생성 페이지: 생성 완료
체험단 생성 페이지 -> 광고주: 광고주 대시보드로 리다이렉트
```

## 11. 테스트 시나리오

### 11.1 정상 생성 (이미지 있음)
- **Given**: 로그인된 광고주
- **When**: 모든 필드를 올바르게 입력하고 이미지 업로드 후 제출
- **Then**: Campaign 생성, 이미지 업로드 성공, 광고주 대시보드로 이동

### 11.2 정상 생성 (이미지 없음)
- **Given**: 로그인된 광고주
- **When**: 이미지 없이 모든 필수 필드 입력 후 제출
- **Then**: Campaign 생성, 기본 이미지 사용, 광고주 대시보드로 이동

### 11.3 모집 종료일이 시작일보다 이른 경우
- **Given**: 로그인된 광고주
- **When**: end_date < start_date로 입력
- **Then**: "모집 종료일은 시작일 이후여야 합니다" 에러 메시지 표시

### 11.4 이미지 크기 초과
- **Given**: 로그인된 광고주
- **When**: 5MB를 초과하는 이미지 업로드
- **Then**: "이미지 크기는 최대 5MB입니다" 에러 메시지 표시

### 11.5 광고주 권한 없음
- **Given**: 로그인된 사용자 (인플루언서 또는 역할 미등록)
- **When**: 체험단 생성 페이지 접근
- **Then**: "광고주 정보를 먼저 등록해주세요" 메시지, 광고주 정보 등록 페이지로 리다이렉트

## 12. 참고 문서

- `docs/userflow.md`: 체험단 등록 플로우 (4)
- `docs/prd.md`: 체험단 생성 기능 요구사항 (6.3.1)
- `docs/database.md`: Campaign 테이블 스키마 (3.4)
