# UC-006: 체험단 모집 조기종료

## 1. 유스케이스 정보

| 항목 | 내용 |
|------|------|
| **유스케이스 ID** | UC-006 |
| **유스케이스 이름** | 체험단 모집 조기종료 |
| **액터** | 광고주 (본인 체험단만) |
| **우선순위** | 중간 |
| **관련 기능** | 체험단 관리 |

## 2. 사전조건 (Preconditions)

- 사용자가 로그인 상태
- User.role이 'advertiser'
- 광고주가 생성한 체험단 존재
- Campaign.status가 'RECRUITING'

## 3. 사후조건 (Postconditions)

### 성공 시
- Campaign.status가 'CLOSED'로 업데이트
- Campaign.closed_at이 현재 시각으로 설정
- 새로운 지원 불가 처리
- 체험단 관리 페이지 새로고침

### 실패 시
- 에러 메시지 표시
- 체험단 상태 유지

## 4. 주요 플로우 (Main Flow)

1. 광고주가 체험단 관리 페이지(`/advertiser/campaign/<campaign_id>`)에서 "모집 조기종료" 버튼 클릭
2. **시스템**: 확인 모달 표시
   - "모집을 종료하시겠습니까? 종료 후에는 취소할 수 없습니다."
3. 광고주가 "확인" 버튼 클릭
4. **시스템**: 로그인 여부 검증
5. **시스템**: 광고주 권한 검증
   - Advertiser 테이블에서 user_id로 레코드 조회
   - 광고주 정보 미등록 시: 403 Forbidden
6. **시스템**: 체험단 소유권 검증
   - Campaign의 advertiser_id와 현재 Advertiser ID 비교
   - 소유권 없음: 403 Forbidden
7. **시스템**: 모집 상태 검증
   - Campaign.status 확인
   - 이미 종료된 경우 (CLOSED): "이미 종료된 체험단입니다" + 플로우 중단
8. **시스템**: 조기종료 가능 여부 검증
   - 현재 날짜가 모집 시작일 이후인지 확인
   - 시작 전: "아직 모집이 시작되지 않았습니다" + 플로우 중단
9. **시스템**: Campaign 업데이트
   - status를 'CLOSED'로 변경
   - closed_at을 NOW()로 설정
10. **시스템**: 체험단 관리 페이지 리로드
11. **시스템**: "모집이 조기종료되었습니다" 메시지 표시

## 5. 대체 플로우 (Alternative Flows)

### 5.1 미로그인 상태
- **시점**: 4단계 (로그인 검증)
- **조건**: 세션에 user_id 없음
- **처리**:
  - 로그인 페이지로 리다이렉트

### 5.2 광고주 권한 없음
- **시점**: 5단계 (광고주 권한 검증)
- **조건**: Advertiser 테이블에 user_id로 레코드 없음
- **처리**:
  - 403 Forbidden 응답

### 5.3 체험단 소유권 없음
- **시점**: 6단계 (소유권 검증)
- **조건**: Campaign.advertiser_id ≠ 현재 Advertiser ID
- **처리**:
  - 403 Forbidden 응답
  - "접근 권한이 없습니다" 메시지

### 5.4 이미 종료된 체험단
- **시점**: 7단계 (모집 상태 검증)
- **조건**: Campaign.status = 'CLOSED' 또는 'SELECTED'
- **처리**:
  - "이미 종료된 체험단입니다" 메시지 표시
  - 플로우 중단

### 5.5 모집 시작 전
- **시점**: 8단계 (조기종료 가능 여부 검증)
- **조건**: 현재 날짜 < start_date
- **처리**:
  - "아직 모집이 시작되지 않았습니다" 메시지 표시
  - 플로우 중단

### 5.6 확인 모달에서 "취소" 클릭
- **시점**: 3단계 (확인 모달)
- **조건**: 광고주가 "취소" 버튼 클릭
- **처리**:
  - 모달 닫기
  - 플로우 중단

## 6. 예외 플로우 (Exception Flows)

### 6.1 DB 업데이트 실패
- **조건**: Campaign 업데이트 실패
- **처리**:
  - "일시적인 오류가 발생했습니다. 다시 시도해주세요" 메시지 표시
  - 플로우 중단

### 6.2 동시성 문제
- **조건**: 다른 세션에서 동일 체험단을 동시에 종료
- **처리**:
  - 낙관적 잠금 또는 비관적 잠금 사용
  - "이미 처리되었습니다" 메시지 표시

## 7. 비즈니스 규칙 (Business Rules)

### BR-001: 모집 중 상태만 종료 가능
- Campaign.status가 'RECRUITING'일 때만 조기종료 가능
- 'CLOSED' 또는 'SELECTED' 상태는 종료 불가

### BR-002: 종료 후 상태 변경 불가
- 한 번 종료한 체험단은 다시 모집 중으로 변경 불가 (Phase 1)
- Phase 2에서 재개 기능 추가 검토

### BR-003: 본인 체험단만 종료 가능
- Campaign.advertiser_id와 현재 광고주 ID 일치 확인
- 다른 광고주의 체험단 종료 불가

### BR-004: 종료 시각 기록
- closed_at 필드에 종료 시각 기록
- 통계 및 감사 목적

## 8. UI/UX 요구사항

### 버튼
- "모집 조기종료" 버튼 (Danger/Warning)
  - 조건: Campaign.status = 'RECRUITING'일 때만 표시

### 모달
- 제목: "모집 조기종료"
- 내용: "모집을 종료하시겠습니까? 종료 후에는 취소할 수 없습니다."
- 버튼:
  - "확인" (Danger)
  - "취소" (Secondary)

### 메시지
- 성공: "모집이 조기종료되었습니다"
- 에러:
  - "이미 종료된 체험단입니다"
  - "아직 모집이 시작되지 않았습니다"
  - "접근 권한이 없습니다"

## 9. 데이터 모델

### 입력 데이터
```json
{
  "campaign_id": 1
}
```

### 출력 데이터 (성공 시)
```json
{
  "campaign_id": 1,
  "status": "CLOSED",
  "closed_at": "2025-11-14T12:00:00Z"
}
```

## 10. 시퀀스 다이어그램

```
광고주 -> 체험단 관리 페이지: "모집 조기종료" 클릭
체험단 관리 페이지 -> 광고주: 확인 모달 표시
광고주 -> 체험단 관리 페이지: "확인" 클릭
체험단 관리 페이지 -> AuthService: 로그인 검증
AuthService --> 체험단 관리 페이지: 검증 성공
체험단 관리 페이지 -> DB (Advertiser): 광고주 권한 검증
DB (Advertiser) --> 체험단 관리 페이지: 검증 성공
체험단 관리 페이지 -> DB (Campaign): 소유권 및 상태 검증
DB (Campaign) --> 체험단 관리 페이지: 검증 성공
체험단 관리 페이지 -> DB (Campaign): Campaign 업데이트 (status=CLOSED, closed_at=NOW())
DB (Campaign) --> 체험단 관리 페이지: 업데이트 완료
체험단 관리 페이지 -> 광고주: 페이지 리로드 + 성공 메시지
```

## 11. 테스트 시나리오

### 11.1 정상 조기종료
- **Given**: 광고주가 생성한 모집 중인 체험단
- **When**: "모집 조기종료" 클릭 후 확인
- **Then**: Campaign.status = 'CLOSED', closed_at 설정, "모집이 조기종료되었습니다" 메시지

### 11.2 이미 종료된 체험단
- **Given**: 이미 종료된 체험단 (status = 'CLOSED')
- **When**: 조기종료 시도
- **Then**: "이미 종료된 체험단입니다" 에러 메시지

### 11.3 모집 시작 전
- **Given**: 모집 시작일이 미래인 체험단
- **When**: 조기종료 시도
- **Then**: "아직 모집이 시작되지 않았습니다" 에러 메시지

### 11.4 다른 광고주의 체험단
- **Given**: 다른 광고주가 생성한 체험단
- **When**: 조기종료 시도
- **Then**: 403 Forbidden 응답

### 11.5 확인 모달에서 취소
- **Given**: 광고주가 생성한 모집 중인 체험단
- **When**: "모집 조기종료" 클릭 후 모달에서 "취소"
- **Then**: 모달 닫기, 상태 변화 없음

## 12. 참고 문서

- `docs/userflow.md`: 모집 조기종료 플로우 (6.3)
- `docs/prd.md`: 모집 조기종료 기능 요구사항 (6.3.5)
- `docs/database.md`: Campaign 테이블 스키마 (3.4)
