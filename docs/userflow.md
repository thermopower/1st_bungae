# 체험단 플랫폼 사용자 플로우

## 1. 회원가입 및 로그인 플로우

### 1.1 회원가입 플로우

#### 입력
- 사용자가 회원가입 페이지에 접속
- 이메일 주소 입력
- 비밀번호 입력 (확인 포함)
- "회원가입" 버튼 클릭

#### 처리
1. **입력 검증**
   - 이메일 형식 검증 (정규식)
   - 비밀번호 강도 검증 (최소 8자, 영문/숫자 포함)
   - 비밀번호 확인 일치 여부 검증

2. **검증 실패 시**
   - 에러 메시지 표시
   - 해당 입력 필드 하이라이트
   - 플로우 중단

3. **검증 성공 시**
   - Supabase Auth API 호출 (회원가입 요청)

4. **Supabase 응답 처리**
   - **성공 (201 Created)**
     - User 레코드 생성 (DB에 사용자 정보 저장)
     - 이메일 인증 메일 발송 (Supabase 자동)
     - 세션 생성 (액세스 토큰, 리프레시 토큰)

   - **실패 (이메일 중복 등)**
     - 에러 메시지 표시
     - 플로우 중단

5. **역할 선택 페이지로 리다이렉트**
   - 사용자 ID를 세션에 저장
   - URL: `/role-selection`

#### 출력
- **성공**: 역할 선택 페이지 표시
- **실패**: 회원가입 페이지에 에러 메시지 표시

#### 엣지케이스 대응
- **네트워크 오류**: "네트워크 연결을 확인해주세요" 메시지 표시
- **Supabase 서비스 다운**: "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요" 메시지
- **이메일 인증 만료**: 재발송 버튼 제공

---

### 1.2 역할 선택 플로우 (회원가입 직후)

#### 입력
- 역할 선택 페이지에서 광고주 또는 인플루언서 선택
- "다음" 버튼 클릭

#### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **역할 선택 검증**
   - 선택되지 않은 경우: "역할을 선택해주세요" 메시지 표시

3. **역할 정보 임시 저장**
   - 세션에 선택한 역할 저장 (`role: advertiser | influencer`)

4. **리다이렉트**
   - **광고주 선택**: `/advertiser/register` (광고주 정보 등록 페이지)
   - **인플루언서 선택**: `/influencer/register` (인플루언서 정보 등록 페이지)

#### 출력
- 선택한 역할에 맞는 정보 등록 페이지로 이동

#### 엣지케이스 대응
- **중복 접근**: 이미 역할 정보가 등록된 사용자가 접근 시 홈으로 리다이렉트
- **세션 만료**: 로그인 페이지로 리다이렉트

---

### 1.3 로그인 플로우

#### 입력
- 사용자가 로그인 페이지에 접속
- 이메일 주소 입력
- 비밀번호 입력
- "로그인" 버튼 클릭

#### 처리
1. **입력 검증**
   - 이메일 형식 검증
   - 비밀번호 입력 여부 확인

2. **Supabase Auth API 호출 (로그인 요청)**
   - 이메일, 비밀번호 전송

3. **Supabase 응답 처리**
   - **성공 (200 OK)**
     - 세션 생성 (액세스 토큰, 리프레시 토큰 저장)
     - DB에서 사용자 정보 조회 (User 테이블)
     - 사용자 역할 확인 (Advertiser 또는 Influencer 테이블 조회)

   - **실패 (401 Unauthorized)**
     - "이메일 또는 비밀번호가 일치하지 않습니다" 메시지 표시
     - 플로우 중단

4. **역할 확인 후 리다이렉트**
   - **역할 미등록 (Advertiser, Influencer 레코드 없음)**
     - 역할 선택 페이지로 리다이렉트 (`/role-selection`)

   - **광고주 역할 등록됨**
     - 광고주 대시보드로 리다이렉트 (`/advertiser/dashboard`)

   - **인플루언서 역할 등록됨**
     - 홈(체험단 탐색) 페이지로 리다이렉트 (`/`)

#### 출력
- **성공**: 역할에 맞는 페이지로 리다이렉트
- **실패**: 로그인 페이지에 에러 메시지 표시

#### 엣지케이스 대응
- **이메일 미인증**: "이메일 인증을 완료해주세요" 메시지 + 재발송 버튼
- **계정 정지**: "계정이 정지되었습니다. 관리자에게 문의하세요" 메시지
- **네트워크 오류**: "네트워크 연결을 확인해주세요" 메시지

---

## 2. 광고주 정보 등록 플로우

### 입력
- 광고주 정보 등록 페이지 (`/advertiser/register`)에 접속
- 다음 정보 입력:
  - 이름 (공통)
  - 생년월일 (공통, YYYY-MM-DD)
  - 휴대폰번호 (공통, 010-XXXX-XXXX)
  - 업체명
  - 주소 (우편번호 찾기 + 상세주소)
  - 업장 전화번호 (XXX-XXXX-XXXX)
  - 사업자등록번호 (XXX-XX-XXXXX)
  - 대표자명
- "등록" 버튼 클릭

### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **중복 등록 검증**
   - Advertiser 테이블에서 현재 사용자 ID로 레코드 조회
   - **이미 등록된 경우**: "이미 광고주 정보가 등록되어 있습니다" 메시지 + 홈으로 리다이렉트

3. **입력 검증**
   - 이름: 2자 이상, 한글/영문만
   - 생년월일: YYYY-MM-DD 형식, 만 19세 이상
   - 휴대폰번호: 010-XXXX-XXXX 형식, 중복 여부 확인
   - 업체명: 2자 이상
   - 주소: 우편번호, 기본주소, 상세주소 입력 확인
   - 업장 전화번호: XXX-XXXX-XXXX 형식
   - 사업자등록번호: XXX-XX-XXXXX 형식, 중복 여부 확인
   - 대표자명: 2자 이상, 한글/영문만

4. **검증 실패 시**
   - 에러 메시지 표시
   - 해당 입력 필드 하이라이트
   - 플로우 중단

5. **검증 성공 시**
   - User 테이블 업데이트 (이름, 생년월일, 휴대폰번호)
   - Advertiser 테이블에 레코드 생성 (업체명, 주소, 업장 전화번호, 사업자등록번호, 대표자명)
   - 트랜잭션으로 처리 (원자성 보장)

6. **DB 저장 성공**
   - 세션에 역할 정보 저장 (`role: advertiser`)
   - 광고주 대시보드로 리다이렉트 (`/advertiser/dashboard`)

#### 출력
- **성공**: "광고주 정보가 등록되었습니다" 메시지 + 광고주 대시보드로 이동
- **실패**: 정보 등록 페이지에 에러 메시지 표시

#### 엣지케이스 대응
- **사업자등록번호 중복**: "이미 등록된 사업자등록번호입니다" 메시지
- **휴대폰번호 중복**: "이미 사용 중인 휴대폰번호입니다" 메시지
- **DB 저장 실패**: "일시적인 오류가 발생했습니다. 다시 시도해주세요" 메시지
- **트랜잭션 롤백**: User 테이블 업데이트 실패 시 전체 롤백

---

## 3. 인플루언서 정보 등록 플로우

### 입력
- 인플루언서 정보 등록 페이지 (`/influencer/register`)에 접속
- 다음 정보 입력:
  - 이름 (공통)
  - 생년월일 (공통, YYYY-MM-DD)
  - 휴대폰번호 (공통, 010-XXXX-XXXX)
  - SNS 채널명
  - 채널링크 (URL)
  - 팔로워수 (숫자)
- "등록" 버튼 클릭

### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **중복 등록 검증**
   - Influencer 테이블에서 현재 사용자 ID로 레코드 조회
   - **이미 등록된 경우**: "이미 인플루언서 정보가 등록되어 있습니다" 메시지 + 홈으로 리다이렉트

3. **입력 검증**
   - 이름: 2자 이상, 한글/영문만
   - 생년월일: YYYY-MM-DD 형식, 만 14세 이상
   - 휴대폰번호: 010-XXXX-XXXX 형식, 중복 여부 확인
   - SNS 채널명: 2자 이상
   - 채널링크: URL 형식 검증 (http:// 또는 https://)
   - 팔로워수: 0 이상의 정수

4. **검증 실패 시**
   - 에러 메시지 표시
   - 해당 입력 필드 하이라이트
   - 플로우 중단

5. **검증 성공 시**
   - User 테이블 업데이트 (이름, 생년월일, 휴대폰번호)
   - Influencer 테이블에 레코드 생성 (SNS 채널명, 채널링크, 팔로워수)
   - 트랜잭션으로 처리 (원자성 보장)

6. **DB 저장 성공**
   - 세션에 역할 정보 저장 (`role: influencer`)
   - 홈(체험단 탐색) 페이지로 리다이렉트 (`/`)

#### 출력
- **성공**: "인플루언서 정보가 등록되었습니다" 메시지 + 홈으로 이동
- **실패**: 정보 등록 페이지에 에러 메시지 표시

#### 엣지케이스 대응
- **채널링크 중복**: "이미 등록된 채널링크입니다" 메시지
- **휴대폰번호 중복**: "이미 사용 중인 휴대폰번호입니다" 메시지
- **DB 저장 실패**: "일시적인 오류가 발생했습니다. 다시 시도해주세요" 메시지
- **트랜잭션 롤백**: User 테이블 업데이트 실패 시 전체 롤백

---

## 4. 체험단 등록 플로우 (광고주)

### 입력
- 광고주 대시보드에서 "체험단 등록" 버튼 클릭
- 체험단 등록 페이지 (`/advertiser/campaign/create`)에 접속
- 다음 정보 입력:
  - 체험단 제목 (예: "신메뉴 파스타 체험단 모집")
  - 체험단 설명 (상세 내용, 에디터)
  - 모집 인원 (숫자)
  - 모집 시작일 (YYYY-MM-DD)
  - 모집 종료일 (YYYY-MM-DD)
  - 제공 혜택 (예: "무료 식사 제공")
  - 체험 조건 (예: "인스타그램 리뷰 필수")
  - 대표 이미지 업로드 (선택)
- "등록" 버튼 클릭

### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **광고주 권한 검증**
   - Advertiser 테이블에서 현재 사용자 ID로 레코드 조회
   - **광고주 정보 미등록 시**: "광고주 정보를 먼저 등록해주세요" 메시지 + 광고주 정보 등록 페이지로 리다이렉트

3. **입력 검증**
   - 체험단 제목: 5자 이상 100자 이하
   - 체험단 설명: 20자 이상 2000자 이하
   - 모집 인원: 1명 이상 100명 이하
   - 모집 시작일: 오늘 이후 날짜
   - 모집 종료일: 모집 시작일 이후 날짜
   - 제공 혜택: 10자 이상 500자 이하
   - 체험 조건: 10자 이상 500자 이하
   - 대표 이미지: 이미지 파일 형식 검증 (jpg, png, gif), 최대 5MB

4. **검증 실패 시**
   - 에러 메시지 표시
   - 해당 입력 필드 하이라이트
   - 플로우 중단

5. **이미지 업로드 처리 (선택사항)**
   - **이미지가 있는 경우**:
     - Supabase Storage에 이미지 업로드
     - 업로드 성공 시 이미지 URL 반환
     - **업로드 실패 시**: "이미지 업로드에 실패했습니다" 메시지 + 플로우 중단

   - **이미지가 없는 경우**: 기본 이미지 URL 사용

6. **검증 성공 시**
   - Campaign 테이블에 레코드 생성
     - advertiser_id: 현재 사용자의 Advertiser ID
     - title, description, quota, start_date, end_date, benefits, conditions
     - image_url: 업로드된 이미지 URL 또는 기본 이미지
     - status: "모집중" (RECRUITING)
     - created_at: 현재 시각

7. **DB 저장 성공**
   - 광고주 대시보드로 리다이렉트 (`/advertiser/dashboard`)

#### 출력
- **성공**: "체험단이 등록되었습니다" 메시지 + 광고주 대시보드로 이동
- **실패**: 체험단 등록 페이지에 에러 메시지 표시

#### 엣지케이스 대응
- **이미지 업로드 실패**: "이미지 업로드에 실패했습니다. 다시 시도해주세요" 메시지
- **Storage 용량 초과**: "스토리지 용량이 부족합니다. 관리자에게 문의하세요" 메시지
- **DB 저장 실패**: "일시적인 오류가 발생했습니다. 다시 시도해주세요" 메시지
- **날짜 검증 오류**: "모집 종료일은 시작일 이후여야 합니다" 메시지

---

## 5. 체험단 탐색 및 지원 플로우 (인플루언서)

### 5.1 체험단 탐색 플로우

#### 입력
- 사용자가 홈 페이지 (`/`)에 접속
- 체험단 목록 표시 (페이지네이션)
- 검색 필터 적용 (선택):
  - 검색어 (제목, 설명)
  - 모집 상태 (모집중, 모집종료)
  - 정렬 (최신순, 마감임박순, 인기순)

#### 처리
1. **Campaign 테이블 조회**
   - status가 "모집중" (RECRUITING)인 체험단 조회
   - 검색 필터 적용 (검색어, 상태)
   - 정렬 조건 적용 (created_at DESC, end_date ASC, etc.)
   - 페이지네이션 적용 (한 페이지당 12개)

2. **각 체험단 정보 표시**
   - 대표 이미지
   - 제목
   - 모집 인원 / 지원자 수
   - 모집 종료일 (D-day)
   - 제공 혜택 (요약)

3. **체험단 카드 클릭 시**
   - 체험단 상세 페이지로 이동 (`/campaign/<campaign_id>`)

#### 출력
- 체험단 목록 페이지 렌더링
- 검색 결과에 따른 목록 표시

#### 엣지케이스 대응
- **체험단 없음**: "현재 모집 중인 체험단이 없습니다" 메시지 표시
- **검색 결과 없음**: "검색 결과가 없습니다" 메시지 표시
- **DB 조회 실패**: "일시적인 오류가 발생했습니다" 메시지 표시

---

### 5.2 체험단 상세 조회 플로우

#### 입력
- 체험단 목록에서 특정 체험단 클릭
- 체험단 상세 페이지 (`/campaign/<campaign_id>`)에 접속

#### 처리
1. **Campaign 조회**
   - campaign_id로 Campaign 테이블 조회
   - **체험단 없음**: 404 페이지 표시

2. **체험단 정보 표시**
   - 대표 이미지
   - 제목
   - 설명 (전체)
   - 모집 인원 / 현재 지원자 수
   - 모집 기간 (시작일 ~ 종료일)
   - 제공 혜택
   - 체험 조건
   - 광고주 정보 (업체명, 주소)

3. **지원 버튼 표시 여부 결정**
   - **미로그인 시**: "로그인이 필요합니다" 메시지 + 로그인 버튼
   - **로그인 + 인플루언서 정보 미등록**: "인플루언서 정보를 먼저 등록해주세요" 메시지 + 정보 등록 버튼
   - **로그인 + 인플루언서 정보 등록 + 모집중**: "지원하기" 버튼 표시
   - **로그인 + 이미 지원함**: "지원완료" 비활성화 버튼 표시
   - **모집 종료**: "모집이 종료되었습니다" 메시지 표시

4. **"지원하기" 버튼 클릭 시**
   - 체험단 지원 페이지로 이동 (`/campaign/<campaign_id>/apply`)

#### 출력
- 체험단 상세 정보 페이지 렌더링
- 지원 버튼 상태 표시

#### 엣지케이스 대응
- **체험단 없음 (404)**: "존재하지 않는 체험단입니다" 메시지 + 홈으로 리다이렉트
- **모집 종료된 체험단**: "모집이 종료되었습니다" 메시지 표시
- **DB 조회 실패**: "일시적인 오류가 발생했습니다" 메시지

---

### 5.3 체험단 지원 플로우

#### 입력
- 체험단 상세 페이지에서 "지원하기" 버튼 클릭
- 체험단 지원 페이지 (`/campaign/<campaign_id>/apply`)에 접속
- 지원 사유 입력 (텍스트 영역, 선택사항)
- "지원하기" 버튼 클릭

#### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **인플루언서 정보 등록 여부 검증**
   - Influencer 테이블에서 현재 사용자 ID로 레코드 조회
   - **인플루언서 정보 미등록 시**: "인플루언서 정보를 먼저 등록해주세요" 메시지 + 정보 등록 페이지로 리다이렉트

3. **체험단 존재 여부 검증**
   - campaign_id로 Campaign 테이블 조회
   - **체험단 없음**: 404 페이지 표시

4. **모집 상태 검증**
   - Campaign의 status 확인
   - **모집 종료 (CLOSED)**: "모집이 종료된 체험단입니다" 메시지 + 체험단 상세 페이지로 리다이렉트

5. **모집 기간 검증**
   - 현재 날짜가 모집 기간 내인지 확인 (start_date <= 현재 <= end_date)
   - **모집 기간 외**: "모집 기간이 아닙니다" 메시지 + 체험단 상세 페이지로 리다이렉트

6. **중복 지원 검증**
   - Application 테이블에서 (campaign_id, influencer_id) 조회
   - **이미 지원한 경우**: "이미 지원한 체험단입니다" 메시지 + 체험단 상세 페이지로 리다이렉트

7. **모집 인원 초과 검증**
   - Campaign의 quota와 현재 지원자 수 (Application 개수) 비교
   - **정원 초과**: "모집 인원이 마감되었습니다" 메시지 + 체험단 상세 페이지로 리다이렉트

8. **지원 사유 검증 (선택사항)**
   - **입력된 경우**: 1000자 이하 검증
   - **검증 실패 시**: 에러 메시지 표시 + 플로우 중단

9. **검증 성공 시**
   - Application 테이블에 레코드 생성
     - campaign_id: 지원할 체험단 ID
     - influencer_id: 현재 사용자의 Influencer ID
     - application_reason: 지원 사유 (선택)
     - status: "지원완료" (APPLIED)
     - applied_at: 현재 시각

10. **DB 저장 성공**
    - 체험단 상세 페이지로 리다이렉트 (`/campaign/<campaign_id>`)

#### 출력
- **성공**: "지원이 완료되었습니다" 메시지 + 체험단 상세 페이지로 이동
- **실패**: 지원 페이지에 에러 메시지 표시

#### 엣지케이스 대응
- **중복 지원**: "이미 지원한 체험단입니다" 메시지
- **모집 인원 초과**: "모집 인원이 마감되었습니다" 메시지
- **모집 기간 외**: "모집 기간이 아닙니다" 메시지
- **DB 저장 실패**: "일시적인 오류가 발생했습니다. 다시 시도해주세요" 메시지
- **동시성 문제 (Race Condition)**: 트랜잭션 격리 수준 설정 + 재시도 로직

---

## 6. 체험단 관리 및 인플루언서 선정 플로우 (광고주)

### 6.1 광고주 대시보드 플로우

#### 입력
- 광고주가 대시보드 페이지 (`/advertiser/dashboard`)에 접속

#### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **광고주 권한 검증**
   - Advertiser 테이블에서 현재 사용자 ID로 레코드 조회
   - **광고주 정보 미등록 시**: "광고주 정보를 먼저 등록해주세요" 메시지 + 광고주 정보 등록 페이지로 리다이렉트

3. **체험단 목록 조회**
   - Campaign 테이블에서 현재 광고주의 체험단 조회 (advertiser_id = 현재 Advertiser ID)
   - 정렬: created_at DESC (최신순)

4. **각 체험단 정보 표시**
   - 제목
   - 모집 상태 (모집중, 모집종료, 선정완료)
   - 모집 인원 / 지원자 수
   - 모집 종료일
   - 관리 버튼
     - "상세보기" 버튼
     - **모집중인 경우**: "조기종료" 버튼 표시
     - **모집종료인 경우**: "인플루언서 선정" 버튼 표시

5. **버튼 클릭 시**
   - "상세보기": 체험단 관리 상세 페이지로 이동 (`/advertiser/campaign/<campaign_id>`)
   - "조기종료": 모집 조기종료 확인 모달 표시
   - "인플루언서 선정": 인플루언서 선정 페이지로 이동 (`/advertiser/campaign/<campaign_id>/select`)

#### 출력
- 광고주 대시보드 렌더링
- 체험단 목록 및 관리 버튼 표시

#### 엣지케이스 대응
- **체험단 없음**: "등록된 체험단이 없습니다" 메시지 + "체험단 등록" 버튼 표시
- **DB 조회 실패**: "일시적인 오류가 발생했습니다" 메시지

---

### 6.2 체험단 관리 상세 플로우

#### 입력
- 광고주 대시보드에서 "상세보기" 버튼 클릭
- 체험단 관리 상세 페이지 (`/advertiser/campaign/<campaign_id>`)에 접속

#### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **광고주 권한 검증**
   - Advertiser 테이블에서 현재 사용자 ID로 레코드 조회
   - **광고주 정보 미등록 시**: 403 Forbidden 페이지 표시

3. **체험단 소유권 검증**
   - campaign_id로 Campaign 조회
   - Campaign의 advertiser_id와 현재 Advertiser ID 비교
   - **소유권 없음**: 403 Forbidden 페이지 표시

4. **체험단 정보 표시**
   - 대표 이미지
   - 제목, 설명
   - 모집 인원 / 지원자 수
   - 모집 기간
   - 제공 혜택, 체험 조건
   - 모집 상태

5. **지원자 목록 조회**
   - Application 테이블에서 campaign_id로 지원자 조회
   - JOIN Influencer, User 테이블 (인플루언서 정보, 사용자 정보)
   - 정렬: applied_at ASC (선착순)

6. **각 지원자 정보 표시**
   - 인플루언서 이름
   - SNS 채널명, 채널링크
   - 팔로워 수
   - 지원 사유
   - 지원 일시
   - 선정 상태 (지원완료, 선정됨, 탈락)

7. **관리 버튼 표시**
   - **모집중인 경우**: "조기종료" 버튼
   - **모집종료인 경우**: "인플루언서 선정" 버튼

#### 출력
- 체험단 관리 상세 페이지 렌더링
- 지원자 목록 및 관리 버튼 표시

#### 엣지케이스 대응
- **체험단 없음 (404)**: "존재하지 않는 체험단입니다" 메시지 + 대시보드로 리다이렉트
- **소유권 없음 (403)**: "접근 권한이 없습니다" 메시지
- **지원자 없음**: "아직 지원자가 없습니다" 메시지 표시
- **DB 조회 실패**: "일시적인 오류가 발생했습니다" 메시지

---

### 6.3 모집 조기종료 플로우

#### 입력
- 체험단 관리 페이지에서 "조기종료" 버튼 클릭
- 확인 모달에서 "확인" 버튼 클릭

#### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **광고주 권한 검증**
   - Advertiser 테이블에서 현재 사용자 ID로 레코드 조회
   - **광고주 정보 미등록 시**: 403 Forbidden 응답

3. **체험단 소유권 검증**
   - campaign_id로 Campaign 조회
   - Campaign의 advertiser_id와 현재 Advertiser ID 비교
   - **소유권 없음**: 403 Forbidden 응답

4. **모집 상태 검증**
   - Campaign의 status 확인
   - **이미 종료된 경우 (CLOSED)**: "이미 종료된 체험단입니다" 메시지 + 플로우 중단

5. **조기종료 가능 여부 검증**
   - 현재 날짜가 모집 시작일 이후인지 확인
   - **시작 전**: "아직 모집이 시작되지 않았습니다" 메시지 + 플로우 중단

6. **검증 성공 시**
   - Campaign의 status를 "모집종료" (CLOSED)로 업데이트
   - closed_at: 현재 시각 저장

7. **DB 업데이트 성공**
   - 체험단 관리 페이지 리로드 (`/advertiser/campaign/<campaign_id>`)

#### 출력
- **성공**: "모집이 조기종료되었습니다" 메시지 + 페이지 리로드
- **실패**: 에러 메시지 표시

#### 엣지케이스 대응
- **이미 종료된 체험단**: "이미 종료된 체험단입니다" 메시지
- **모집 시작 전**: "아직 모집이 시작되지 않았습니다" 메시지
- **DB 업데이트 실패**: "일시적인 오류가 발생했습니다. 다시 시도해주세요" 메시지

---

### 6.4 인플루언서 선정 플로우

#### 입력
- 체험단 관리 페이지에서 "인플루언서 선정" 버튼 클릭
- 인플루언서 선정 페이지 (`/advertiser/campaign/<campaign_id>/select`)에 접속
- 지원자 목록에서 선정할 인플루언서 체크박스 선택 (최대 모집인원만큼)
- "선정하기" 버튼 클릭

#### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **광고주 권한 검증**
   - Advertiser 테이블에서 현재 사용자 ID로 레코드 조회
   - **광고주 정보 미등록 시**: 403 Forbidden 페이지 표시

3. **체험단 소유권 검증**
   - campaign_id로 Campaign 조회
   - Campaign의 advertiser_id와 현재 Advertiser ID 비교
   - **소유권 없음**: 403 Forbidden 페이지 표시

4. **모집 종료 여부 검증**
   - Campaign의 status 확인
   - **모집중인 경우 (RECRUITING)**: "모집을 먼저 종료해주세요" 메시지 + 플로우 중단

5. **선정 완료 여부 검증**
   - Campaign의 status 확인
   - **이미 선정 완료 (SELECTED)**: "이미 인플루언서 선정이 완료되었습니다" 메시지 + 플로우 중단

6. **지원자 목록 조회 및 표시**
   - Application 테이블에서 campaign_id로 지원자 조회
   - JOIN Influencer, User 테이블
   - 각 지원자 정보 표시 (이름, SNS 채널, 팔로워 수, 지원 사유)

7. **선정 인원 검증**
   - 선택된 인플루언서 수 확인
   - **선택 없음**: "선정할 인플루언서를 선택해주세요" 메시지 + 플로우 중단
   - **모집인원 초과**: "모집인원을 초과했습니다 (최대 {quota}명)" 메시지 + 플로우 중단

8. **선정된 Application ID 검증**
   - 각 Application ID가 해당 Campaign의 지원자인지 확인
   - **잘못된 ID**: 400 Bad Request 응답

9. **검증 성공 시**
   - 트랜잭션 시작
   - 선정된 Application의 status를 "선정됨" (SELECTED)로 업데이트
   - 선정되지 않은 Application의 status를 "탈락" (REJECTED)로 업데이트
   - Campaign의 status를 "선정완료" (SELECTED)로 업데이트
   - selected_at: 현재 시각 저장
   - 트랜잭션 커밋

10. **DB 업데이트 성공**
    - 체험단 관리 페이지로 리다이렉트 (`/advertiser/campaign/<campaign_id>`)

#### 출력
- **성공**: "인플루언서 선정이 완료되었습니다" 메시지 + 체험단 관리 페이지로 이동
- **실패**: 선정 페이지에 에러 메시지 표시

#### 엣지케이스 대응
- **모집중인 체험단**: "모집을 먼저 종료해주세요" 메시지
- **이미 선정 완료**: "이미 인플루언서 선정이 완료되었습니다" 메시지
- **선정 인원 초과**: "모집인원을 초과했습니다" 메시지
- **지원자 없음**: "지원자가 없습니다" 메시지
- **DB 업데이트 실패**: 트랜잭션 롤백 + "일시적인 오류가 발생했습니다. 다시 시도해주세요" 메시지
- **동시 선정 요청**: 트랜잭션 격리 수준 설정 + 재시도 로직

---

## 7. 추가 플로우

### 7.1 로그아웃 플로우

#### 입력
- 네비게이션 바에서 "로그아웃" 버튼 클릭

#### 처리
1. **세션 삭제**
   - 서버 세션에서 사용자 정보 삭제
   - Supabase Auth 세션 종료 (액세스 토큰, 리프레시 토큰 무효화)

2. **쿠키 삭제**
   - 세션 쿠키 삭제

3. **홈으로 리다이렉트**
   - URL: `/`

#### 출력
- "로그아웃되었습니다" 메시지 + 홈 페이지로 이동

---

### 7.2 프로필 수정 플로우 (광고주)

#### 입력
- 광고주 대시보드에서 "프로필 수정" 버튼 클릭
- 프로필 수정 페이지 (`/advertiser/profile`)에 접속
- 수정할 정보 입력 (이름, 휴대폰번호, 업체명, 주소, 업장 전화번호)
- "수정" 버튼 클릭

#### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **광고주 권한 검증**
   - Advertiser 테이블에서 현재 사용자 ID로 레코드 조회
   - **광고주 정보 미등록 시**: 403 Forbidden 페이지 표시

3. **입력 검증** (수정 가능 필드만)
   - 이름: 2자 이상, 한글/영문만
   - 휴대폰번호: 010-XXXX-XXXX 형식, 중복 여부 확인 (본인 제외)
   - 업체명: 2자 이상
   - 주소: 우편번호, 기본주소, 상세주소 확인
   - 업장 전화번호: XXX-XXXX-XXXX 형식

4. **검증 실패 시**
   - 에러 메시지 표시
   - 플로우 중단

5. **검증 성공 시**
   - User 테이블 업데이트 (이름, 휴대폰번호)
   - Advertiser 테이블 업데이트 (업체명, 주소, 업장 전화번호)
   - 트랜잭션으로 처리

6. **DB 업데이트 성공**
   - 프로필 페이지 리로드

#### 출력
- **성공**: "프로필이 수정되었습니다" 메시지
- **실패**: 에러 메시지 표시

#### 엣지케이스 대응
- **휴대폰번호 중복**: "이미 사용 중인 휴대폰번호입니다" 메시지 (본인 제외)
- **DB 업데이트 실패**: 트랜잭션 롤백 + 에러 메시지

---

### 7.3 프로필 수정 플로우 (인플루언서)

#### 입력
- 네비게이션 바에서 "프로필 수정" 버튼 클릭
- 프로필 수정 페이지 (`/influencer/profile`)에 접속
- 수정할 정보 입력 (이름, 휴대폰번호, SNS 채널명, 채널링크, 팔로워수)
- "수정" 버튼 클릭

#### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **인플루언서 권한 검증**
   - Influencer 테이블에서 현재 사용자 ID로 레코드 조회
   - **인플루언서 정보 미등록 시**: 403 Forbidden 페이지 표시

3. **입력 검증** (수정 가능 필드만)
   - 이름: 2자 이상, 한글/영문만
   - 휴대폰번호: 010-XXXX-XXXX 형식, 중복 여부 확인 (본인 제외)
   - SNS 채널명: 2자 이상
   - 채널링크: URL 형식, 중복 여부 확인 (본인 제외)
   - 팔로워수: 0 이상의 정수

4. **검증 실패 시**
   - 에러 메시지 표시
   - 플로우 중단

5. **검증 성공 시**
   - User 테이블 업데이트 (이름, 휴대폰번호)
   - Influencer 테이블 업데이트 (SNS 채널명, 채널링크, 팔로워수)
   - 트랜잭션으로 처리

6. **DB 업데이트 성공**
   - 프로필 페이지 리로드

#### 출력
- **성공**: "프로필이 수정되었습니다" 메시지
- **실패**: 에러 메시지 표시

#### 엣지케이스 대응
- **휴대폰번호 중복**: "이미 사용 중인 휴대폰번호입니다" 메시지 (본인 제외)
- **채널링크 중복**: "이미 등록된 채널링크입니다" 메시지 (본인 제외)
- **DB 업데이트 실패**: 트랜잭션 롤백 + 에러 메시지

---

### 7.4 지원 내역 조회 플로우 (인플루언서)

#### 입력
- 네비게이션 바에서 "내 지원내역" 버튼 클릭
- 지원 내역 페이지 (`/influencer/applications`)에 접속

#### 처리
1. **로그인 여부 검증**
   - 세션에 사용자 ID 존재 여부 확인
   - **미로그인 시**: 로그인 페이지로 리다이렉트

2. **인플루언서 권한 검증**
   - Influencer 테이블에서 현재 사용자 ID로 레코드 조회
   - **인플루언서 정보 미등록 시**: "인플루언서 정보를 먼저 등록해주세요" 메시지 + 정보 등록 페이지로 리다이렉트

3. **지원 내역 조회**
   - Application 테이블에서 influencer_id로 지원 내역 조회
   - JOIN Campaign, Advertiser 테이블 (체험단 정보, 광고주 정보)
   - 정렬: applied_at DESC (최신순)

4. **각 지원 내역 표시**
   - 체험단 제목
   - 광고주 업체명
   - 지원 일시
   - 선정 상태 (지원완료, 선정됨, 탈락)
   - 체험단 상세 링크

#### 출력
- 지원 내역 페이지 렌더링
- 지원 내역 목록 표시

#### 엣지케이스 대응
- **지원 내역 없음**: "아직 지원한 체험단이 없습니다" 메시지 + 홈 바로가기 버튼
- **DB 조회 실패**: "일시적인 오류가 발생했습니다" 메시지

---

## 8. 권한 및 접근 제어 매트릭스

| 페이지 / 기능 | 미로그인 | 로그인 (역할 미등록) | 광고주 | 인플루언서 |
|---|:---:|:---:|:---:|:---:|
| 홈 (체험단 탐색) | ✅ | ✅ | ✅ | ✅ |
| 체험단 상세 조회 | ✅ | ✅ | ✅ | ✅ |
| 로그인 / 회원가입 | ✅ | ❌ | ❌ | ❌ |
| 역할 선택 | ❌ | ✅ | ❌ | ❌ |
| 광고주 정보 등록 | ❌ | ✅ | ❌ | ❌ |
| 인플루언서 정보 등록 | ❌ | ✅ | ❌ | ❌ |
| 체험단 지원 | ❌ | ❌ | ❌ | ✅ |
| 지원 내역 조회 | ❌ | ❌ | ❌ | ✅ |
| 광고주 대시보드 | ❌ | ❌ | ✅ | ❌ |
| 체험단 등록 | ❌ | ❌ | ✅ | ❌ |
| 체험단 관리 | ❌ | ❌ | ✅ (본인) | ❌ |
| 모집 조기종료 | ❌ | ❌ | ✅ (본인) | ❌ |
| 인플루언서 선정 | ❌ | ❌ | ✅ (본인) | ❌ |
| 프로필 수정 | ❌ | ❌ | ✅ | ✅ |

---

## 9. 상태 전이 다이어그램

### 체험단 상태 (Campaign Status)

```
[생성] → RECRUITING (모집중)
         ↓
         ├─ (조기종료 or 모집종료일 도래) → CLOSED (모집종료)
         ↓
         └─ (인플루언서 선정) → SELECTED (선정완료)
```

### 지원 상태 (Application Status)

```
[지원] → APPLIED (지원완료)
         ↓
         ├─ (선정) → SELECTED (선정됨)
         ↓
         └─ (탈락) → REJECTED (탈락)
```

---

## 10. 에러 처리 원칙

### HTTP 상태 코드 사용
- **200 OK**: 성공
- **201 Created**: 리소스 생성 성공 (회원가입, 체험단 등록 등)
- **400 Bad Request**: 입력 검증 실패
- **401 Unauthorized**: 인증 실패 (로그인 필요)
- **403 Forbidden**: 권한 없음 (광고주/인플루언서 권한 필요)
- **404 Not Found**: 리소스 없음 (체험단 없음 등)
- **409 Conflict**: 중복 리소스 (이메일 중복, 중복 지원 등)
- **500 Internal Server Error**: 서버 오류

### 사용자 친화적 에러 메시지
- 기술적 용어 지양
- 구체적인 해결 방법 제시
- 예: "이메일 또는 비밀번호가 일치하지 않습니다" (❌ "401 Unauthorized")

### 로깅
- 모든 에러는 서버 로그에 기록
- 민감 정보(비밀번호, 토큰)는 로그에 포함하지 않음

---

## 11. 보안 고려사항

### 인증 (Authentication)
- Supabase Auth 사용 (JWT 기반)
- 액세스 토큰 + 리프레시 토큰
- 토큰 만료 시 자동 갱신 또는 로그인 페이지로 리다이렉트

### 인가 (Authorization)
- 세션 기반 권한 검증
- 각 요청마다 사용자 역할 확인 (광고주/인플루언서)
- 리소스 소유권 검증 (체험단 수정 시 본인 체험단인지 확인)

### CSRF 보호
- WTForms의 CSRF 토큰 사용
- 모든 POST/PUT/DELETE 요청에 CSRF 토큰 필수

### SQL Injection 방지
- SQLAlchemy ORM 사용 (Parameterized Query)
- 원시 SQL 사용 지양

### XSS 방지
- Jinja2 자동 이스케이프 활성화
- 사용자 입력 출력 시 HTML 태그 이스케이프

---

## 12. 성능 최적화

### 데이터베이스 쿼리 최적화
- N+1 문제 해결: JOIN 또는 `joinedload()` 사용
- 인덱스 설정: 자주 조회되는 컬럼 (email, campaign_id, influencer_id)

### 페이지네이션
- 체험단 목록, 지원자 목록 등에 페이지네이션 적용
- 한 페이지당 12개 (체험단), 20개 (지원자)

### 이미지 최적화
- Supabase Storage 사용
- 이미지 압축 (최대 5MB)
- CDN 활용 (Supabase Storage CDN)

### 캐싱
- 자주 변경되지 않는 데이터 캐싱 (체험단 목록, 사용자 정보)
- Flask-Caching 사용 고려

---

## 13. 확장 가능성

### 향후 추가 가능한 기능
1. **알림 기능**
   - 지원 완료 시 광고주에게 알림
   - 선정/탈락 시 인플루언서에게 알림

2. **리뷰 및 평가**
   - 인플루언서가 체험 후 리뷰 작성
   - 광고주가 인플루언서 평가

3. **체험단 카테고리**
   - 음식점, 카페, 뷰티, 패션 등 카테고리 분류

4. **추천 시스템**
   - 인플루언서 팔로워 수, 관심 분야 기반 체험단 추천

5. **결제 시스템**
   - 광고주가 체험단 등록 시 수수료 결제

---

## 문서 변경 이력
- **2025-11-14**: 초기 작성 (회원가입, 로그인, 역할 등록, 체험단 등록/지원/관리 플로우)
