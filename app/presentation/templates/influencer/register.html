{% extends "base.html" %}

{% block title %}인플루언서 정보 등록 - 1st Bungae{% endblock %}

{% block extra_css %}
<style>
.required-mark {
    color: #dc3545;
}
.form-section {
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
}
.help-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}
.error-message {
    display: none;
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}
.error-message.show {
    display: block;
}
.form-control.is-invalid {
    border-color: #dc3545;
}
.form-control.is-valid {
    border-color: #28a745;
}
.server-error-alert {
    display: none;
}
.server-error-alert.show {
    display: block;
}
.channel-type-selector {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}
.channel-type-selector input[type="radio"] {
    display: none;
}
.channel-type-selector label {
    padding: 0.5rem 1rem;
    border: 2px solid #dee2e6;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
}
.channel-type-selector input[type="radio"]:checked + label {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}
.channel-type-selector label:hover {
    border-color: #0d6efd;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow">
                <div class="card-body p-4 p-md-5">
                    <h2 class="text-center mb-3">인플루언서 정보 등록</h2>
                    <p class="text-center text-muted mb-5">
                        체험단에 지원하기 위해 인플루언서 정보를 등록해주세요.
                    </p>

                    <!-- Flash 메시지 -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <!-- 서버 에러 메시지 (JavaScript로 제어) -->
                    <div id="serverErrorAlert" class="alert alert-danger alert-dismissible fade show server-error-alert" role="alert">
                        <span id="serverErrorMessage"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>

                    <form id="influencerForm" method="POST" action="{{ url_for('influencer.register_influencer') }}" novalidate>
                        {{ form.hidden_tag() }}

                        <!-- 공통 정보 섹션 -->
                        <div class="form-section">
                            <h5 class="mb-3">기본 정보</h5>

                            <!-- 이름 -->
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    이름 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.name(class="form-control", id="name", placeholder="홍길동",
                                   autocomplete="name", maxlength="100") }}
                                <div id="name-error" class="error-message"></div>
                                {% if form.name.errors %}
                                    <div class="error-message show">{{ form.name.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 생년월일 -->
                            <div class="mb-3">
                                <label for="birthDate" class="form-label">
                                    생년월일 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.birth_date(class="form-control", id="birthDate", type="date") }}
                                <small class="help-text">만 19세 이상만 가입 가능합니다.</small>
                                <div id="birthDate-error" class="error-message"></div>
                                {% if form.birth_date.errors %}
                                    <div class="error-message show">{{ form.birth_date.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 휴대폰번호 -->
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">
                                    휴대폰번호 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.phone_number(class="form-control", id="phoneNumber",
                                   placeholder="010-1234-5678", autocomplete="tel", maxlength="13") }}
                                <small class="help-text">숫자만 입력하시면 자동으로 포맷됩니다.</small>
                                <div id="phoneNumber-error" class="error-message"></div>
                                {% if form.phone_number.errors %}
                                    <div class="error-message show">{{ form.phone_number.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- SNS 채널 정보 섹션 -->
                        <div class="form-section">
                            <h5 class="mb-3">SNS 채널 정보</h5>

                            <!-- 채널 유형 -->
                            <div class="mb-3">
                                <label class="form-label">
                                    채널 유형 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                <div class="channel-type-selector">
                                    <input type="radio" name="channel_type" id="channelType-youtube" value="youtube" checked>
                                    <label for="channelType-youtube">
                                        <i class="bi bi-youtube"></i> YouTube
                                    </label>

                                    <input type="radio" name="channel_type" id="channelType-instagram" value="instagram">
                                    <label for="channelType-instagram">
                                        <i class="bi bi-instagram"></i> Instagram
                                    </label>

                                    <input type="radio" name="channel_type" id="channelType-blog" value="blog">
                                    <label for="channelType-blog">
                                        <i class="bi bi-pencil-square"></i> Blog
                                    </label>

                                    <input type="radio" name="channel_type" id="channelType-other" value="other">
                                    <label for="channelType-other">
                                        <i class="bi bi-three-dots"></i> 기타
                                    </label>
                                </div>
                                <div id="channelType-error" class="error-message"></div>
                            </div>

                            <!-- 채널명 -->
                            <div class="mb-3">
                                <label for="channelName" class="form-label">
                                    채널명 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.channel_name(class="form-control", id="channelName",
                                   placeholder="내 채널", maxlength="100") }}
                                <small class="help-text">SNS 채널 또는 블로그의 이름을 입력해주세요.</small>
                                <div id="channelName-error" class="error-message"></div>
                                {% if form.channel_name.errors %}
                                    <div class="error-message show">{{ form.channel_name.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 채널 URL -->
                            <div class="mb-3">
                                <label for="channelUrl" class="form-label">
                                    채널 링크 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.channel_url(class="form-control", id="channelUrl",
                                   placeholder="https://", type="url") }}
                                <small class="help-text">채널 또는 블로그의 전체 URL을 입력해주세요. (http:// 또는 https:// 포함)</small>
                                <div id="channelUrl-error" class="error-message"></div>
                                {% if form.channel_url.errors %}
                                    <div class="error-message show">{{ form.channel_url.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 팔로워 수 -->
                            <div class="mb-3">
                                <label for="followerCount" class="form-label">
                                    팔로워 수 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.follower_count(class="form-control", id="followerCount",
                                   placeholder="0", type="number", min="0") }}
                                <small class="help-text">현재 팔로워, 구독자 또는 방문자 수를 입력해주세요.</small>
                                <div id="followerCount-error" class="error-message"></div>
                                {% if form.follower_count.errors %}
                                    <div class="error-message show">{{ form.follower_count.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" id="submitButton" class="btn btn-primary btn-lg px-5">
                                <span id="submitButtonText">등록하기</span>
                                <span id="submitButtonSpinner" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display: none;"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 폼 상태 관리
const formState = {
    name: '',
    birthDate: '',
    phoneNumber: '',
    channelName: '',
    channelUrl: '',
    followerCount: '',
    channelType: 'youtube',
    errors: {},
    isSubmitting: false,
    serverError: null
};

// DOM 요소
const form = document.getElementById('influencerForm');
const submitButton = document.getElementById('submitButton');
const submitButtonText = document.getElementById('submitButtonText');
const submitButtonSpinner = document.getElementById('submitButtonSpinner');

// 전화번호 자동 포맷팅 (010-XXXX-XXXX)
function formatPhoneNumber(input) {
    const value = input.value.replace(/\D/g, '');
    let formatted = '';

    if (value.length <= 3) {
        formatted = value;
    } else if (value.length <= 7) {
        formatted = value.slice(0, 3) + '-' + value.slice(3);
    } else {
        formatted = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
    }

    input.value = formatted;
    formState.phoneNumber = formatted;
    clearFieldError('phoneNumber');
}

// 팔로워 수 숫자만 입력 허용
function formatFollowerCount(input) {
    const value = input.value.replace(/\D/g, '');
    input.value = value;
    formState.followerCount = value;
    clearFieldError('followerCount');
}

// 입력 이벤트 리스너
document.getElementById('phoneNumber').addEventListener('input', function() {
    formatPhoneNumber(this);
});

document.getElementById('followerCount').addEventListener('input', function() {
    formatFollowerCount(this);
});

// 필드별 에러 표시
function showFieldError(fieldName, message) {
    const errorDiv = document.getElementById(fieldName + '-error');
    const inputField = document.getElementById(fieldName);

    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.add('show');
    }

    if (inputField) {
        inputField.classList.add('is-invalid');
        inputField.classList.remove('is-valid');
    }
}

// 필드별 에러 제거
function clearFieldError(fieldName) {
    const errorDiv = document.getElementById(fieldName + '-error');
    const inputField = document.getElementById(fieldName);

    if (errorDiv) {
        errorDiv.textContent = '';
        errorDiv.classList.remove('show');
    }

    if (inputField) {
        inputField.classList.remove('is-invalid');
    }
}

// 모든 에러 제거
function clearAllErrors() {
    const errorDivs = document.querySelectorAll('.error-message');
    errorDivs.forEach(div => {
        div.textContent = '';
        div.classList.remove('show');
    });

    const inputFields = document.querySelectorAll('.form-control');
    inputFields.forEach(field => {
        field.classList.remove('is-invalid');
        field.classList.remove('is-valid');
    });
}

// 생년월일 검증 (만 19세 이상)
function isAdult(birthDate) {
    const today = new Date();
    const birth = new Date(birthDate);
    const age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();

    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        return age - 1 >= 19;
    }
    return age >= 19;
}

// 날짜 유효성 검증
function isValidDate(dateString) {
    const regex = /^\d{4}-\d{2}-\d{2}$/;
    if (!regex.test(dateString)) return false;

    const date = new Date(dateString);
    return date instanceof Date && !isNaN(date);
}

// URL 유효성 검증
function isValidUrl(url) {
    try {
        new URL(url);
        return url.startsWith('http://') || url.startsWith('https://');
    } catch {
        return false;
    }
}

// 공통 필드 검증
function validateCommonFields() {
    let isValid = true;

    // 이름 검증
    const name = document.getElementById('name').value.trim();
    if (!name || name.length < 2) {
        showFieldError('name', '이름은 최소 2자 이상 입력해주세요.');
        isValid = false;
    } else if (!/^[가-힣a-zA-Z\s]+$/.test(name)) {
        showFieldError('name', '이름은 한글 또는 영문만 입력 가능합니다.');
        isValid = false;
    } else {
        clearFieldError('name');
    }

    // 생년월일 검증
    const birthDate = document.getElementById('birthDate').value;
    if (!birthDate) {
        showFieldError('birthDate', '생년월일을 입력해주세요.');
        isValid = false;
    } else if (!isValidDate(birthDate)) {
        showFieldError('birthDate', '올바른 날짜 형식이 아닙니다. (YYYY-MM-DD)');
        isValid = false;
    } else if (!isAdult(birthDate)) {
        showFieldError('birthDate', '만 19세 이상만 가입 가능합니다.');
        isValid = false;
    } else {
        clearFieldError('birthDate');
    }

    // 휴대폰번호 검증
    const phoneNumber = document.getElementById('phoneNumber').value;
    if (!phoneNumber) {
        showFieldError('phoneNumber', '휴대폰번호를 입력해주세요.');
        isValid = false;
    } else if (!/^010-\d{4}-\d{4}$/.test(phoneNumber)) {
        showFieldError('phoneNumber', '휴대폰번호 형식이 올바르지 않습니다. (010-XXXX-XXXX)');
        isValid = false;
    } else {
        clearFieldError('phoneNumber');
    }

    return isValid;
}

// 인플루언서 필드 검증
function validateInfluencerFields() {
    let isValid = validateCommonFields();

    // 채널명 검증
    const channelName = document.getElementById('channelName').value.trim();
    if (!channelName || channelName.length < 2) {
        showFieldError('channelName', '채널명을 입력해주세요.');
        isValid = false;
    } else {
        clearFieldError('channelName');
    }

    // 채널 URL 검증
    const channelUrl = document.getElementById('channelUrl').value.trim();
    if (!channelUrl) {
        showFieldError('channelUrl', '채널 링크를 입력해주세요.');
        isValid = false;
    } else if (!isValidUrl(channelUrl)) {
        showFieldError('channelUrl', '올바른 URL 형식이 아닙니다. (http:// 또는 https://)');
        isValid = false;
    } else {
        clearFieldError('channelUrl');
    }

    // 팔로워 수 검증
    const followerCount = document.getElementById('followerCount').value;
    if (!followerCount) {
        showFieldError('followerCount', '팔로워 수를 입력해주세요.');
        isValid = false;
    } else if (!/^\d+$/.test(followerCount) || parseInt(followerCount) < 0) {
        showFieldError('followerCount', '팔로워 수는 0 이상의 숫자여야 합니다.');
        isValid = false;
    } else {
        clearFieldError('followerCount');
    }

    return isValid;
}

// 제출 버튼 상태 업데이트
function updateSubmitButton(isSubmitting) {
    if (isSubmitting) {
        submitButton.disabled = true;
        submitButtonText.textContent = '등록 중...';
        submitButtonSpinner.style.display = 'inline-block';
    } else {
        submitButton.disabled = false;
        submitButtonText.textContent = '등록하기';
        submitButtonSpinner.style.display = 'none';
    }
}

// 폼 제출
form.addEventListener('submit', function(e) {
    e.preventDefault();

    // 유효성 검사
    const isValid = validateInfluencerFields();
    if (!isValid) {
        // 첫 번째 에러 필드로 스크롤
        const firstError = document.querySelector('.is-invalid');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
        }
        return;
    }

    // 제출 중 상태로 변경
    formState.isSubmitting = true;
    updateSubmitButton(true);

    // 폼 제출
    this.submit();
});
</script>
{% endblock %}
