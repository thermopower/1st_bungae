{% extends "base.html" %}

{% block title %}광고주 정보 등록 - 1st Bungae{% endblock %}

{% block extra_css %}
<style>
.required-mark {
    color: #dc3545;
}
.form-section {
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
}
.help-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}
.error-message {
    display: none;
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}
.error-message.show {
    display: block;
}
.form-control.is-invalid {
    border-color: #dc3545;
}
.form-control.is-valid {
    border-color: #28a745;
}
.server-error-alert {
    display: none;
}
.server-error-alert.show {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow">
                <div class="card-body p-4 p-md-5">
                    <h2 class="text-center mb-3">광고주 정보 등록</h2>
                    <p class="text-center text-muted mb-5">
                        체험단을 생성하기 위해 광고주 정보를 등록해주세요.
                    </p>

                    <!-- Flash 메시지 -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <!-- 서버 에러 메시지 (JavaScript로 제어) -->
                    <div id="serverErrorAlert" class="alert alert-danger alert-dismissible fade show server-error-alert" role="alert">
                        <span id="serverErrorMessage"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>

                    <form id="advertiserForm" method="POST" action="{{ url_for('advertiser.register_advertiser') }}" novalidate>
                        {{ form.hidden_tag() }}

                        <!-- 공통 정보 섹션 -->
                        <div class="form-section">
                            <h5 class="mb-3">기본 정보</h5>

                            <!-- 이름 -->
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    이름 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.name(class="form-control", id="name", placeholder="홍길동",
                                   autocomplete="name", maxlength="100") }}
                                <div id="name-error" class="error-message"></div>
                                {% if form.name.errors %}
                                    <div class="error-message show">{{ form.name.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 생년월일 -->
                            <div class="mb-3">
                                <label for="birthDate" class="form-label">
                                    생년월일 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.birth_date(class="form-control", id="birthDate", type="date",
                                   max=today_date) }}
                                <small class="help-text">만 19세 이상만 가입 가능합니다.</small>
                                <div id="birthDate-error" class="error-message"></div>
                                {% if form.birth_date.errors %}
                                    <div class="error-message show">{{ form.birth_date.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 휴대폰번호 -->
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">
                                    휴대폰번호 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.phone_number(class="form-control", id="phoneNumber",
                                   placeholder="010-1234-5678", autocomplete="tel", maxlength="13") }}
                                <small class="help-text">숫자만 입력하시면 자동으로 포맷됩니다.</small>
                                <div id="phoneNumber-error" class="error-message"></div>
                                {% if form.phone_number.errors %}
                                    <div class="error-message show">{{ form.phone_number.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- 사업자 정보 섹션 -->
                        <div class="form-section">
                            <h5 class="mb-3">사업자 정보</h5>

                            <!-- 업체명 -->
                            <div class="mb-3">
                                <label for="businessName" class="form-label">
                                    업체명 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.business_name(class="form-control", id="businessName",
                                   placeholder="테스트 카페", maxlength="100") }}
                                <div id="businessName-error" class="error-message"></div>
                                {% if form.business_name.errors %}
                                    <div class="error-message show">{{ form.business_name.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 주소 (통합 필드로 단순화) -->
                            <div class="mb-3">
                                <label for="address" class="form-label">
                                    주소 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.address(class="form-control", id="address",
                                   placeholder="서울시 강남구 테헤란로 123, 1층", rows="2") }}
                                <small class="help-text">우편번호, 기본 주소, 상세 주소를 모두 입력해주세요.</small>
                                <div id="address-error" class="error-message"></div>
                                {% if form.address.errors %}
                                    <div class="error-message show">{{ form.address.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 업장 전화번호 -->
                            <div class="mb-3">
                                <label for="businessPhone" class="form-label">
                                    업장 전화번호 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.business_phone(class="form-control", id="businessPhone",
                                   placeholder="02-1234-5678", autocomplete="tel", maxlength="13") }}
                                <small class="help-text">지역번호를 포함하여 입력해주세요. (예: 02-1234-5678)</small>
                                <div id="businessPhone-error" class="error-message"></div>
                                {% if form.business_phone.errors %}
                                    <div class="error-message show">{{ form.business_phone.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 사업자등록번호 -->
                            <div class="mb-3">
                                <label for="businessNumber" class="form-label">
                                    사업자등록번호 <span class="required-mark" aria-label="필수">*</span>
                                    <i class="bi bi-question-circle" data-bs-toggle="tooltip"
                                       title="사업자등록증에 표시된 10자리 번호입니다."></i>
                                </label>
                                {{ form.business_number(class="form-control", id="businessNumber",
                                   placeholder="123-45-67890", maxlength="12") }}
                                <small class="help-text">숫자만 입력하시면 자동으로 포맷됩니다. (XXX-XX-XXXXX)</small>
                                <div id="businessNumber-error" class="error-message"></div>
                                {% if form.business_number.errors %}
                                    <div class="error-message show">{{ form.business_number.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <!-- 대표자명 -->
                            <div class="mb-3">
                                <label for="representativeName" class="form-label">
                                    대표자명 <span class="required-mark" aria-label="필수">*</span>
                                </label>
                                {{ form.representative_name(class="form-control", id="representativeName",
                                   placeholder="김대표", autocomplete="name", maxlength="100") }}
                                <div id="representativeName-error" class="error-message"></div>
                                {% if form.representative_name.errors %}
                                    <div class="error-message show">{{ form.representative_name.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" id="submitButton" class="btn btn-primary btn-lg px-5">
                                <span id="submitButtonText">등록하기</span>
                                <span id="submitButtonSpinner" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display: none;"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 폼 상태 관리
const formState = {
    name: '',
    birthDate: '',
    phoneNumber: '',
    businessName: '',
    address: '',
    businessPhone: '',
    businessNumber: '',
    representativeName: '',
    errors: {},
    isSubmitting: false,
    serverError: null
};

// DOM 요소
const form = document.getElementById('advertiserForm');
const submitButton = document.getElementById('submitButton');
const submitButtonText = document.getElementById('submitButtonText');
const submitButtonSpinner = document.getElementById('submitButtonSpinner');

// 툴팁 초기화
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// 전화번호 자동 포맷팅 (010-XXXX-XXXX)
function formatPhoneNumber(input) {
    const value = input.value.replace(/\D/g, '');
    let formatted = '';

    if (value.length <= 3) {
        formatted = value;
    } else if (value.length <= 7) {
        formatted = value.slice(0, 3) + '-' + value.slice(3);
    } else {
        formatted = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
    }

    input.value = formatted;
    formState.phoneNumber = formatted;
    clearFieldError('phoneNumber');
}

// 사업자등록번호 자동 포맷팅 (XXX-XX-XXXXX)
function formatBusinessNumber(input) {
    const value = input.value.replace(/\D/g, '');
    let formatted = '';

    if (value.length <= 3) {
        formatted = value;
    } else if (value.length <= 5) {
        formatted = value.slice(0, 3) + '-' + value.slice(3);
    } else {
        formatted = value.slice(0, 3) + '-' + value.slice(3, 5) + '-' + value.slice(5, 10);
    }

    input.value = formatted;
    formState.businessNumber = formatted;
    clearFieldError('businessNumber');
}

// 업장 전화번호 자동 포맷팅 (XX-XXXX-XXXX 또는 XXX-XXXX-XXXX)
function formatBusinessPhone(input) {
    const value = input.value.replace(/\D/g, '');
    let formatted = '';

    if (value.length <= 2) {
        formatted = value;
    } else if (value.length <= 3) {
        formatted = value;
    } else if (value.startsWith('02')) {
        // 서울 지역번호 (02)
        if (value.length <= 5) {
            formatted = value.slice(0, 2) + '-' + value.slice(2);
        } else {
            formatted = value.slice(0, 2) + '-' + value.slice(2, 6) + '-' + value.slice(6, 10);
        }
    } else {
        // 기타 지역번호 (031, 032 등)
        if (value.length <= 6) {
            formatted = value.slice(0, 3) + '-' + value.slice(3);
        } else {
            formatted = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
        }
    }

    input.value = formatted;
    formState.businessPhone = formatted;
    clearFieldError('businessPhone');
}

// 입력 이벤트 리스너
document.getElementById('phoneNumber').addEventListener('input', function() {
    formatPhoneNumber(this);
});

document.getElementById('businessNumber').addEventListener('input', function() {
    formatBusinessNumber(this);
});

document.getElementById('businessPhone').addEventListener('input', function() {
    formatBusinessPhone(this);
});

// 필드별 에러 표시
function showFieldError(fieldName, message) {
    const errorDiv = document.getElementById(fieldName + '-error');
    const inputField = document.getElementById(fieldName);

    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.add('show');
    }

    if (inputField) {
        inputField.classList.add('is-invalid');
        inputField.classList.remove('is-valid');
    }
}

// 필드별 에러 제거
function clearFieldError(fieldName) {
    const errorDiv = document.getElementById(fieldName + '-error');
    const inputField = document.getElementById(fieldName);

    if (errorDiv) {
        errorDiv.textContent = '';
        errorDiv.classList.remove('show');
    }

    if (inputField) {
        inputField.classList.remove('is-invalid');
    }
}

// 모든 에러 제거
function clearAllErrors() {
    const errorDivs = document.querySelectorAll('.error-message');
    errorDivs.forEach(div => {
        div.textContent = '';
        div.classList.remove('show');
    });

    const inputFields = document.querySelectorAll('.form-control');
    inputFields.forEach(field => {
        field.classList.remove('is-invalid');
        field.classList.remove('is-valid');
    });
}

// 생년월일 검증 (만 19세 이상)
function isAdult(birthDate) {
    const today = new Date();
    const birth = new Date(birthDate);
    const age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();

    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        return age - 1 >= 19;
    }
    return age >= 19;
}

// 날짜 유효성 검증
function isValidDate(dateString) {
    const regex = /^\d{4}-\d{2}-\d{2}$/;
    if (!regex.test(dateString)) return false;

    const date = new Date(dateString);
    return date instanceof Date && !isNaN(date);
}

// 공통 필드 검증
function validateCommonFields() {
    let isValid = true;

    // 이름 검증
    const name = document.getElementById('name').value.trim();
    if (!name || name.length < 2) {
        showFieldError('name', '이름은 최소 2자 이상 입력해주세요.');
        isValid = false;
    } else if (!/^[가-힣a-zA-Z\s]+$/.test(name)) {
        showFieldError('name', '이름은 한글 또는 영문만 입력 가능합니다.');
        isValid = false;
    } else {
        clearFieldError('name');
    }

    // 생년월일 검증
    const birthDate = document.getElementById('birthDate').value;
    if (!birthDate) {
        showFieldError('birthDate', '생년월일을 입력해주세요.');
        isValid = false;
    } else if (!isValidDate(birthDate)) {
        showFieldError('birthDate', '올바른 날짜 형식이 아닙니다. (YYYY-MM-DD)');
        isValid = false;
    } else if (!isAdult(birthDate)) {
        showFieldError('birthDate', '만 19세 이상만 가입 가능합니다.');
        isValid = false;
    } else {
        clearFieldError('birthDate');
    }

    // 휴대폰번호 검증
    const phoneNumber = document.getElementById('phoneNumber').value;
    if (!phoneNumber) {
        showFieldError('phoneNumber', '휴대폰번호를 입력해주세요.');
        isValid = false;
    } else if (!/^010-\d{4}-\d{4}$/.test(phoneNumber)) {
        showFieldError('phoneNumber', '휴대폰번호 형식이 올바르지 않습니다. (010-XXXX-XXXX)');
        isValid = false;
    } else {
        clearFieldError('phoneNumber');
    }

    return isValid;
}

// 광고주 필드 검증
function validateAdvertiserFields() {
    let isValid = validateCommonFields();

    // 업체명 검증
    const businessName = document.getElementById('businessName').value.trim();
    if (!businessName || businessName.length < 2) {
        showFieldError('businessName', '업체명을 입력해주세요.');
        isValid = false;
    } else {
        clearFieldError('businessName');
    }

    // 주소 검증
    const address = document.getElementById('address').value.trim();
    if (!address) {
        showFieldError('address', '주소를 입력해주세요.');
        isValid = false;
    } else {
        clearFieldError('address');
    }

    // 업장 전화번호 검증
    const businessPhone = document.getElementById('businessPhone').value;
    if (!businessPhone) {
        showFieldError('businessPhone', '업장 전화번호를 입력해주세요.');
        isValid = false;
    } else if (!/^\d{2,3}-\d{3,4}-\d{4}$/.test(businessPhone)) {
        showFieldError('businessPhone', '전화번호 형식이 올바르지 않습니다.');
        isValid = false;
    } else {
        clearFieldError('businessPhone');
    }

    // 사업자등록번호 검증
    const businessNumber = document.getElementById('businessNumber').value;
    if (!businessNumber) {
        showFieldError('businessNumber', '사업자등록번호를 입력해주세요.');
        isValid = false;
    } else if (!/^\d{3}-\d{2}-\d{5}$/.test(businessNumber)) {
        showFieldError('businessNumber', '사업자등록번호 형식이 올바르지 않습니다. (XXX-XX-XXXXX)');
        isValid = false;
    } else {
        clearFieldError('businessNumber');
    }

    // 대표자명 검증
    const representativeName = document.getElementById('representativeName').value.trim();
    if (!representativeName || representativeName.length < 2) {
        showFieldError('representativeName', '대표자명을 입력해주세요.');
        isValid = false;
    } else {
        clearFieldError('representativeName');
    }

    return isValid;
}

// 제출 버튼 상태 업데이트
function updateSubmitButton(isSubmitting) {
    if (isSubmitting) {
        submitButton.disabled = true;
        submitButtonText.textContent = '등록 중...';
        submitButtonSpinner.style.display = 'inline-block';
    } else {
        submitButton.disabled = false;
        submitButtonText.textContent = '등록하기';
        submitButtonSpinner.style.display = 'none';
    }
}

// 폼 제출
form.addEventListener('submit', function(e) {
    e.preventDefault();

    // 유효성 검사
    const isValid = validateAdvertiserFields();
    if (!isValid) {
        // 첫 번째 에러 필드로 스크롤
        const firstError = document.querySelector('.is-invalid');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
        }
        return;
    }

    // 제출 중 상태로 변경
    formState.isSubmitting = true;
    updateSubmitButton(true);

    // 폼 제출
    this.submit();
});
</script>
{% endblock %}
